%   ##############################
%   ###    SETUPSCRIPT.sty     ###
%   ##############################
%
% Custom package for loading preamble and abbrevations into my LaTeX documents.
% Compiles with pdfLaTeX and biber (if bibliography option), with TeX Live 2014
%
% ### USAGE
%     - In your preamble specify:
%     - \documentclass[<options>]{memoir/tufte/beamer}
%     - \usepackage[<options>]{setupscript}
%
% ### OPTIONS
%     - REQUIRED: [memoir] or [tufte] or [beamer] document class-specific setups
%     - [bibliography] loads biblatex and formats bibliography
%     - [framedtheorem] loads mdframed and styles for framed theorem envs
%
% ### TO DO
% - Add more options for specific title page layouts
% - fix crefs for theorems

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{setupscript}[2014/08/06 Adam Altmejd's custom setup script]

%% ##################### CLASS SPECIFIC PACKAGES #############################

\newif\if@memoir\@memoirfalse
\DeclareOption{memoir}{
  \@memoirtrue
}
\newif\if@tufte\@tuftefalse
\DeclareOption{tufte}{
  \@tuftetrue
}
\newif\if@beamer\@beamerfalse
\DeclareOption{beamer}{
  \@beamertrue
}
\newif\if@bibliography\@bibliographyfalse
\DeclareOption{bibliography}{
  \@bibliographytrue
}
\newif\if@pgf\@pgffalse
\DeclareOption{pgf}{
  \@pgftrue
}
\newif\if@framedtheorem\@framedtheoremfalse
\DeclareOption{framedtheorem}{
  \@framedtheoremtrue
}
\newif\if@knitr\@knitrfalse
\DeclareOption{knitr}{
  \@knitrtrue
}

\ProcessOptions\relax

%% ###########################################################################
%% ##################### PREAMBLE ############################################
%% ###########################################################################

%% ##################### Typography ##########################################

\RequirePackage[T1]{fontenc} % Should be loaded before inputenc
\RequirePackage[utf8]{inputenc} %utf8x should be avoided, does not work with biblatex
\RequirePackage[kerning]{microtype} % Better looking text
\RequirePackage[babel]{csquotes} % Better looking quotes
\RequirePackage{babel} % Language control
% \RequirePackage[a-1b]{pdfx} % A-1b standards compilant pdf

\RequirePackage{lmodern} % Latin modern font

\if@memoir\if@knitr\else
    \RequirePackage[hyperref]{xcolor} % Needs to be loaded before listings
\fi\fi

%% ##################### MATH / CODE #########################################

\RequirePackage{amsmath,amssymb,amsfonts,mathrsfs,accents,gauss}
\RequirePackage{listings}       % Used to \input code files
\if@beamer\else % Beamer automatically loads amsthm for theorems
    \RequirePackage[amsmath,thmmarks,hyperref]{ntheorem}
    \if@framedtheorem
        \RequirePackage{mdframed} %options declared later
    \fi
\fi

%% ##################### GRAPHICS ############################################

\if@pgf
    \RequirePackage{graphicx,tikz,pgfplots}
    \usetikzlibrary{backgrounds,trees,positioning,arrows,calc}
    \pgfplotsset{compat=newest}
    \DeclareGraphicsExtensions{.pdf,.png,.jpg,.eps}
\fi

\if@memoir
    \RequirePackage{placeins} % Option [section] to create \FloatBarrier automatically at sections
\fi

%% ##################### TABLES ############################################

\RequirePackage{siunitx}
\sisetup{
	group-digits = integer, % group integers in groups of 3 (not decimals)
	input-decimal-markers = {.},
	%table-number-alignment = center-decimal-marker, % try to do it automatically
	table-number-alignment = center, %  requires defining pre post spacing
	input-open-uncertainty = {},
	input-close-uncertainty = {},
	table-align-text-pre = false,
    table-align-text-post = false,
    table-format = -2.2, % defaults, can easily be changed for specific table
    table-space-text-pre ={(},
    table-space-text-post={)}
}
\RequirePackage{booktabs} % Better looking tables
\RequirePackage{threeparttable}

%% ##################### BIBLIOGRAPHY ########################################

\if@bibliography
    % More on bibsettings here:
    % http://tex.stackexchange.com/questions/12806/guidelines-for-customizing-biblatex-styles
    \if@tufte
        % tufte screws with bibs... [nobib] doesn't seem to work??
    \fi
    \if@beamer
        \RequirePackage[
            style=authoryear-comp,
            maxcitenames=2,
            mincitenames=1,
            maxbibnames=5,
            minbibnames=1,
            giveninits=true, % Use initials for first and middle names
            uniquename=false, % Do not add initials if two authors have same name
            useprefix=true,
            sortlocale=en_US,
            dashed=true, % Will output dash instead of repeated author
            sorting=nyt,sortcites=true,hyperref=true,
            isbn=false,url=false,doi=false,eprint=false
        ]{biblatex}
        \AtEveryBibitem{%
            \clearlist{language}%
            \clearfield{month}%
            \clearfield{day}%
        }

        % http://tex.stackexchange.com/questions/202988/beamer-patching-footnotes-warning
        \RequirePackage{silence}
        \WarningFilter{biblatex}{Patching footnotes failed}
    \fi
    \if@memoir
        % \usepackage[
        %     authordate,%authordate,%notes
        %     short,
        %     strict,%
        %     natbib,
        %     bibencoding=inputenc,%
        %     autolang=other,%
        %     backend=biber,%
        %     maxnames=2,%
        %     minnames=1,%
        %     maxbibnames=5,%
        %     minbibnames=3,%
        %     doi=only,%
        %     isbn=false,%
        %     eprint=false,%
        %     numbermonth=false,%
        %     bookpages=false%
        % ]{biblatex-chicago}

        \RequirePackage[
            style=authoryear-comp, % or icomp if ibid
            natbib=true,
            maxcitenames=2,
            mincitenames=1,
            maxbibnames=5,
            minbibnames=1,
            giveninits=true, % Use initials for first and middle names
            uniquename=false, % Do not add initials if two authors have same name
            useprefix=true,
            sortlocale=en_US,
            sorting=nyt,sortcites=true,hyperref=true,
            isbn=false,url=false,doi=false,eprint=false
        ]{biblatex}                     % BIBLATEX Bibliography

        \AtEveryBibitem{%
            \clearlist{language}%
            \clearfield{month}%
            \clearfield{day}%
        }
    \fi
\fi


%% ##################### OTHER USEFUL STUFF ##################################

% \RequirePackage{pdflscape}      % Loads external pdfs in landscape mode
% \RequirePackage{lineno}         % Puts line numbers on everything
% \RequirePackage{lipsum}         % Lorem ipsum generation with \lipsum[]
% \RequirePackage{standalone}     % Ignores preambles from input documents
% \RequirePackage{todonotes}      % Todo notes with for example \todo
% \RequirePackage{aliascnt}       % Alias counters
\RequirePackage{etoolbox} % for programming

\if@beamer
    % Enumitem makes it impossible to use \enumerate
    % \RequirePackage{enumitem} % Needed to easily change space between itemize and labels.
    % \RequirePackage{multicol} % To get multiple columns in TOC
    \RequirePackage{appendixnumberbeamer} % To get new numbering for appendix
\fi

%% ##################### REFERENCES (Loaded last) ############################

\if@memoir
    %hypcap is outdated, test with caption package (with hypcap=true) instead
    %\RequirePackage[all]{hypcap}    % Makes hyperrefs refer to top of figures.
    % Memoir has its own build in subcaption system!
    % \RequirePackage[hypcap=true,hypcapspace=0.5\baselineskip]{caption} % aption for tufte?
    % \RequirePackage[hypcap=true]{subcaption}

\fi

\if@tufte
    % Subcaption stuff seems really buggy with tufte.
    %\RequirePackage{subcaption} %instead of subfigure and subfig, however works poorly
    %\captionsetup{compatibility=false}
    %\RequirePackage{subfig}
    %\RequirePackage[margin=10pt, font=small, labelfont=bf, hypcap=true]{caption}
    \usepackage[caption=false]{subfig}
\fi

\if@beamer
    % Works with beamer nowadays!
    \usepackage{caption}
    \usepackage{subcaption}
    % \captionsetup{
    %     listformat=empty,
    %     tablename=Table,
    %     justification=justified,
    %     labelsep=colon,
    %     position=above,
    %     skip=\onelineskip,
    %     width=\linewidth,
    %     labelfont={small},
    %     font={small}
    % }
\fi


%% ##################### REFERENCES (Loaded last) ############################

% Hyperref should always be loaded in the end.
% If loading standards compilant use options [pdftex,pdfa]
\if@beamer\else
    \RequirePackage{hyperref}
    \definecolor{myblue}{RGB}{100,110,150}
    \hypersetup{
        colorlinks=true,
        citecolor=myblue,
        filecolor=myblue,
        linkcolor=myblue,
        linkbordercolor=myblue,
        urlcolor=myblue
    }
    % But cleveref/hypcap need to be loaded after hyperref
    %\RequirePackage[nameinlink,noabbrev]{cleveref}
    \RequirePackage{cleveref}
\fi
\hypersetup{
    unicode=true,
    pdfauthor={Adam Altmejd},
    bookmarksnumbered=true,
    bookmarksopen=true,
    breaklinks=true
}

%% ##################### LOAD SETTINGS #######################################

\RequirePackage{setupscript-layout}
\RequirePackage{setupscript-syntax}
\RequirePackage{setupscript-abbreviations}

%% ##################### DEBUG (last) ########################################

% Fix bug with listings and breqn
% \let\origlstlisting=\lstlisting
% \let\endoriglstlisting=\endlstlisting
% \renewenvironment{lstlisting}
%     {\mathcode`\-=\hyphenmathcode
%      \everymath{}\mathsurround=0pt\origlstlisting}
%     {\endoriglstlisting}

\if@beamer\else
    \crefname{secinapp}{appendix}{appendices} % Create reference to appendix sections
    \crefname{secinapp}{Appendix}{Appendices}
\fi

%% ##################### END #################################################

\endinput
