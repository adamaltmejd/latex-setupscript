%   ##############################
%   ###    SETUPSCRIPT.sty     ###
%   ##############################
%
% Custom package for loading preamble and abbrevations into my LaTeX documents.
% Compiles with pdfLaTeX and biber (if bibliography option), with TeX Live 2014
%
% ### USAGE
%     - In your preamble specify:
%     - \documentclass[<options>]{memoir/tufte/beamer}
%     - \usepackage[<options>]{setupscript}
%
% ### OPTIONS
%     - REQUIRED: [memoir] or [tufte] or [beamer] document class-specific setups
%     - [bibliography] loads biblatex and formats bibliography
%     - [framedtheorem] loads mdframed and styles for framed theorem envs
%
% ### TO DO
% - Add more options for specific title page layouts

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{setupscript}[2019/10/24 Adam Altmejd's custom setup script]

%% ##################### CLASS SPECIFIC PACKAGES #############################

\newif\if@memoir\@memoirfalse
\DeclareOption{memoir}{
  \@memoirtrue
}
\newif\if@tufte\@tuftefalse
\DeclareOption{tufte}{
  \@tuftetrue
}
\newif\if@beamer\@beamerfalse
\DeclareOption{beamer}{
  \@beamertrue
}
\newif\if@bibliography\@bibliographyfalse
\DeclareOption{bibliography}{
  \@bibliographytrue
}
\newif\if@pgf\@pgffalse
\DeclareOption{pgf}{
  \@pgftrue
}
\newif\if@theorem\@theoremfalse
\DeclareOption{theorem}{
  \@theoremtrue
}
\newif\if@framedtheorem\@framedtheoremfalse
\DeclareOption{framedtheorem}{
  \@framedtheoremtrue
}
\newif\if@knitr\@knitrfalse
\DeclareOption{knitr}{
  \@knitrtrue
}
\newif\if@highlighting\@highlightingfalse
\DeclareOption{highlighting}{
  \@highlightingtrue
}

\ProcessOptions\relax

%% ###########################################################################
%% ##################### PREAMBLE ############################################
%% ###########################################################################

%% ##################### Typography ##########################################

\if@memoir
    \RequirePackage{ebgaramond}
    \RequirePackage[cmintegrals,cmbraces]{newtxmath}
    % ebgaramond-maths is buggy - currently does not show numbers
    % \RequirePackage{ebgaramond-maths} % needs to be loaded after newtxmath,
    \RequirePackage{avant} % Avant Gothic for headings/captions
\else
    \RequirePackage{lmodern} % Latin modern font
\fi

\RequirePackage[T1]{fontenc} % Should be loaded before inputenc
\RequirePackage[utf8]{inputenc} %utf8x should be avoided, does not work with biblatex
\RequirePackage[protrusion=true,expansion=true,final,babel]{microtype} % Better looking text
\RequirePackage[babel]{csquotes} % Better looking quotes
\RequirePackage{babel} % Language control

\if@memoir\if@knitr\else
    \RequirePackage[hyperref]{xcolor} % Needs to be loaded before listings
\fi\fi

\RequirePackage{lipsum} % to add filler text to template. Can remove.

%% ##################### MATH / CODE #########################################

\RequirePackage{amsmath,amssymb,amsfonts}
%\RequirePackage{accents} % provides different accents, does not work with ebgaramond-maths
%\RequirePackage{mathrsfs} % provides \mathscr
%\RequirePackage{gauss} % for matrix opetarations

%\RequirePackage{} % conflicts with newtxmath which provides its own widehat


\if@highlighting\RequirePackage{listings}\fi

\if@beamer\else % Beamer automatically loads amsthm for theorems
    \if@theorem\RequirePackage[amsmath,thmmarks,hyperref]{ntheorem}\fi
    \if@framedtheorem
        \RequirePackage{mdframed} %options declared later
    \fi
\fi

%% ##################### GRAPHICS ############################################

\RequirePackage{graphicx}
\DeclareGraphicsExtensions{.pdf,.png,.jpg,.eps}

\if@pgf
    \RequirePackage{tikz,pgfplots}
    \usetikzlibrary{backgrounds,trees,positioning,arrows,calc}
    \pgfplotsset{compat=newest}
\fi

\if@memoir
    \RequirePackage{placeins} % Option [section] to create \FloatBarrier automatically at sections
\fi

%% ##################### TABLES ############################################

\RequirePackage{siunitx}
\sisetup{
	group-digits = integer, % group integers in groups of 3 (not decimals)
	input-decimal-markers = {.},
	table-number-alignment = center, %  requires defining pre post spacing
	input-open-uncertainty = {},
	input-close-uncertainty = {},
	table-align-text-pre = false,
    table-align-text-post = false,
    table-format = -2.2, % defaults, can easily be changed for specific table
    table-space-text-pre ={(},
    table-space-text-post={)}
}
\RequirePackage{booktabs} % Better looking tables
\RequirePackage{threeparttable}

%% ##################### BIBLIOGRAPHY ########################################

\if@bibliography
    \if@tufte\else
        % tufte screws with bibs... [nobib] doesn't seem to work??

        \usepackage[
            authordate,
            backend=biber,%
            bibencoding=inputenc,
            %babel, % automatically loaded with american language
            short, % always use short format
            noibid, % never use ibid
            strict, % experimental, tries to follow Manual for footnote formatting
            maxbibnames=5,%
            minbibnames=3,%
            uniquename=false, % Do not add initials if two authors have same name
            numbermonth=false,%
            uniquename=false,
            useprefix=true, % print "von" etc (biber only)
            giveninits=true, % Use initials for first and middle names
            sortcites=true, % sort citations in text (when separated by comma)
            date=year,
            doi=only,isbn=false,eprint=false
        ]{biblatex-chicago}

        \AtEveryBibitem{%
            \clearlist{language}%
            \clearfield{month}%
            \clearfield{day}%
        }

        \DeclareFieldFormat[legislation]{citetitle}{{#1}} % no italics of title of legislation in text
        \DeclareFieldFormat[thesis]{title}{\mkbibitalic{#1}}% italics thesis title in bibliography


        \if@beamer
            % http://tex.stackexchange.com/questions/202988/beamer-patching-footnotes-warning
            \RequirePackage{silence}
            \WarningFilter{biblatex}{Patching footnotes failed}
        \fi
    \fi
\fi


%% ##################### OTHER USEFUL STUFF ##################################
\RequirePackage{etoolbox} % for programming new commands etc

\if@beamer
    \RequirePackage{appendixnumberbeamer} % To get new numbering for appendix
\fi

%% ######################### CAPTIONS ##########################################

% Memoir has builting captioning
% Tufte is buggy with caption/subcaption

\if@beamer
    % Caption works with beamer!
    \usepackage{caption}
    \usepackage{subcaption}
    \captionsetup{
        listformat=empty,
        tablename=Table,
        justification=justified,
        labelsep=colon,
        position=above,
        skip=\onelineskip,
        width=\linewidth,
        labelfont={small},
        font={small}
    }
\fi

%% ##################### REFERENCES (Loaded last) ############################

% Hyperref should always be loaded in the end.
% Beamer loads hyperref automatically
\if@beamer\else
    \RequirePackage{hyperref}
    \definecolor{myblue}{RGB}{100,110,150}
    \hypersetup{
        colorlinks=true,
        citecolor=myblue,
        filecolor=myblue,
        linkcolor=myblue,
        linkbordercolor=myblue,
        urlcolor=myblue
    }
\fi
\hypersetup{
    unicode=true,
    pdfauthor={Adam Altmejd},
    bookmarksnumbered=true,
    bookmarksopen=true,
    breaklinks=true
}

%% #############################################################################
%% ##################### LAYOUT ################################################
%% #############################################################################

% Math definitions/environments, not for beamer
\if@beamer\else
    % NON-FRAMED THEOREMS
    \if@theorem
        \theoremstyle{plain}
        \theoremheaderfont{\normalfont\bfseries}\theorembodyfont{\normalfont}
        \theoremseparator{:}
        \newtheorem{definition}{Definition}
        \newtheorem{proposition}{Proposition}
        \newtheorem{theorem}{Theorem}
        \newtheorem{axiom}{Axiom}
        \newtheorem{corollary}{Corollary}
        \newtheorem{lemma}{Lemma}
        \newtheorem{remark}{Remark}
        \newtheorem{example}{Example}
        %Proof
        \theoremstyle{nonumberplain}
        \newtheorem{proof}{Proof}
        \theoremsymbol{\ensuremath{\blacksquare}}
    \fi

    % FRAMED THEOREMS
    \if@framedtheorem
    \mdfsetup{
        framemethod=tikz,
        ntheorem=true
    }
        \mdfdefinestyle{theoremstyle}{%
            linecolor = gray!20,
            linewidth = 1pt,
            innerleftmargin = 5pt,
            innerrightmargin = 5pt,
            innertopmargin = 0pt,
            leftmargin = 0pt,
            rightmargin = 0pt,
            frametitlerule = true,
            frametitlebackgroundcolor = gray!20,
            innertopmargin = \topskip,
            middlelinewidth = 1pt,
            ntheorem = true,
            nobreak = true
        }
        \theorempreskip{5pt}
        \theorempostskip{10pt}
        %Example: \mdtheorem[<mdframedâˆ’options>]{<envname>}[<numberedlike>]{<caption>}[<within>]
        \mdtheorem[style=theoremstyle]{proposition}{Proposition}%[section]
        \mdtheorem[style=theoremstyle]{proof}{Proof}%[section]
        \mdtheorem[style=theoremstyle]{theorem}{Theorem}%[section]
        \mdtheorem[style=theoremstyle]{definition}{Definition}%[section]
        \mdtheorem[style=theoremstyle]{axiom}{Axiom}%[section]
        \mdtheorem[style=theoremstyle]{corollary}{Corollary}%[section]
        \mdtheorem[style=theoremstyle]{lemma}{Lemma}%[section]
        \mdtheorem[style=theoremstyle]{remark}{Remark}%[section]
    \fi
\fi

%% ##################### MEMOIR ################################################
\if@memoir

    %%%%%%%%%%%%%
    % PAGE LAYOUT

    \setlrmarginsandblock{30mm}{30mm}{*} % left right margins
    \setulmarginsandblock{35mm}{40mm}{*} % top bottom margins
    \setheadfoot{\onelineskip}{2\onelineskip} % {headheight}{footskip}
    \setheaderspaces{20mm}{*}{*} % {headdrop}{headsep}{ratio}

    % Indent
    \setlength{\parindent}{2em} % indentation for new paragraphs
    \setSingleSpace{1.1} % Line spacing

    %%%%%%%%%%%%%%%%
    % PAGE Breaking
    % Dealing with widows and orphans
    \clubpenalty=9996
    \widowpenalty=9999
    \brokenpenalty=4991
    \predisplaypenalty=10000
    \postdisplaypenalty=1549
    \displaywidowpenalty=1602

    %\flushbottom % to stretch vboxes to cover full page (won't always work with figures)
    %\checkandfixthelayout[lines] % use "fixed" with raggedbottom

    % Alternatively:
    \raggedbottom % allow textheight to vary somewhat between pages
    \feetatbottom % to ensure footnotes are still at bottom with \raggedbottom
    \checkandfixthelayout[fixed] % use "fixed" with raggedbottom

    %%%%%%%%%%%%%%%
    % Figures

    % Figure Captions (and notes)
    \captionstyle[\centering]{\raggedright} % [short caption]{long caption}
    \captiondelim{. }
    \captionnamefont{\normalsize\sffamily} % \sffamily
    \captiontitlefont{\normalsize\sffamily} % \sffamily

    % To add a note below the figure use \figurenotes{}
    \newcommand{\figurenotes}[1]{%
    \captionstyle[\centering]{} % \raggedright
    \captiontitlefont{\footnotesize\rmfamily}
    \legend{Notes: #1}}

    \newsubfloat{figure}% Allow subfloats in figure environment

    \setfloatadjustment{figure}{\centering}
    \setfloatadjustment{table}{\footnotesize\centering}

    %%%%%%%%%%%%%%%%
    % Abstracts
    \renewcommand{\abstractnamefont}{\sffamily\Large} %\small\normalfont\bfseries
    \renewcommand{\abstracttextfont}{\vspace*{-2.5ex}\normalfont\normalsize\noindent\ignorespaces} %\small
    \setlength{\absleftindent}{0pt}
    \setlength{\absrightindent}{0pt}
    \setlength{\absparindent}{0pt}
    \setlength{\absparsep}{0pt}
    \setlength{\abstitleskip}{0pt}

    %%%%%%%%%%%%%%%%
    % Page styles and counters

    \makepagestyle{setupscript}
    \makeevenhead{setupscript}{}{\normalfont\sffamily\scshape\rightmark}{}
    \makeoddhead{setupscript}{}{\normalfont\sffamily\scshape\leftmark}{}
    \makeevenfoot{setupscript}{}{\normalfont\sffamily\thepage}{}
    \makeoddfoot{setupscript}{}{\normalfont\sffamily\thepage}{}
    \makepsmarks{setupscript}{%
        \nouppercaseheads % use smallcaps instead of uppercase
        \createmark      {chapter}  {both}{nonumber}   {\@chapapp\ }{. \ }
        %\createmark      {section}  {right}{nonumber}   {}           {. \ }
        \createplainmark {toc}      {both}              {\contentsname}
        \createplainmark {lof}      {both}              {\listfigurename}
        \createplainmark {lot}      {both}              {\listtablename}
        \createplainmark {bib}      {both}              {\bibname}
        \createplainmark {index}    {both}              {\indexname}
        \createplainmark {glossary} {both}              {\glossaryname}
    }


    % Use empty for float-only pages
    \mergepagefloatstyle{mergedstyle}{setupscript}{empty}
    \pagestyle{mergedstyle}

    % \aliaspagestyle{chapter}{empty} % no pagestyle on chapter page
    \counterwithout{footnote}{chapter} % continous numbering of footnotes
    \setsecnumdepth{subsection}

    %%%%%%%%%%%%%%%%
    % Chapter Style

    % \makechapterstyle{ssethesis}{%
    % \renewcommand*{\chaptitlefont}{\sffamily\LARGE}
    % \renewcommand*{\chapnamefont}{\sffamily\huge}
    % \renewcommand*{\chapnumfont}{\chapnamefont}
    % \renewcommand*{\printchaptername}{\centering\chapnamefont \@chapapp}
    % \renewcommand*{\printchapternonum}{\centering\chapnamefont}
    % \setlength{\beforechapskip}{4\onelineskip}
    % \setlength{\midchapskip}{2\onelineskip}
    % \setlength{\afterchapskip}{2\onelineskip}
    % }
    % \chapterstyle{ssethesis}
    \makechapterstyle{section2}{%
        \renewcommand*{\chaptitlefont}{\sffamily\LARGE}
        \renewcommand*{\printchaptername}{}
        \renewcommand*{\chapternamenum}{}
        \renewcommand*{\chapnamefont}{}
        \renewcommand*{\chapnumfont}{\chaptitlefont}
        \renewcommand*{\printchapternum}{\chapnumfont \thechapter}
        \renewcommand*{\afterchapternum}{\quad}
        \setlength{\beforechapskip}{2\onelineskip}
        \setlength{\midchapskip}{\onelineskip}
        \setlength{\afterchapskip}{\onelineskip}
    }
    \chapterstyle{section2}

    %%%%%%%%%%%%%%%%
    % Section styles
    % negative ensures no _indentation_ after
    \setsecheadstyle{\sffamily\Large}
    \setbeforesecskip{-4ex plus -1ex minus -0.4ex}
    \setaftersecskip{2.3ex plus 0.4ex}

    \setsubsecheadstyle{\sffamily\large}
    \setbeforesubsecskip{-2.8ex plus -1ex minus -0.4ex}
    \setaftersubsecskip{1.3ex plus 0.3ex}

    \setsubsubsecheadstyle{\sffamily\normalsize}
    \setbeforesubsubsecskip{-2.8ex plus -1ex minus -0.4ex}
    \setaftersubsubsecskip{1.3ex plus 0.3ex}

    % Correct numbering without chapters
    % \renewcommand{\thesection}{\arabic{section}}
    % \renewcommand{\thesubsection}{\thesection.\arabic{subsection}}
    % \makeatletter
    % \let\l@subsection\l@section
    % \let\l@section\l@chapter
    % \makeatother
    \setsecnumdepth{subsection} % Numbering subsections

    %%%%%%%%%%%%%%%%
    % Bibliography
    \setlength{\bibitemsep}{0.5\baselineskip} % small space between items in bib

\fi

%% ##################### BEAMER ################################################
\if@beamer

    \usetheme[height=0mm]{Rochester}
    \usecolortheme[RGB={71,98,176}]{structure}
    \useoutertheme[subsection=false]{miniframes}
    \useinnertheme{rectangles}

    \setbeamercovered{transparent}
    \setbeamertemplate{navigation symbols}{} % no navigation symbols

    \setbeamerfont{title like}{shape=\scshape} % small caps
    \setbeamerfont{frametitle}{shape=\Large}
    \addtobeamertemplate{frametitle}{}{\vspace{-1em}} % smaller top margin (after title)

    %% COLORING
    \setbeamercolor*{structure}{fg=black}
    \setbeamercolor*{frametitle}{fg=black,bg=white}
    \setbeamercolor*{button}{fg=black}
    \setbeamercolor*{palette tertiary}{fg=black,bg=black!10}
    \setbeamercolor*{palette quaternary}{fg=black,bg=black!10}

    %% FOOTNOTES
    % allow footnote without number
    \newcommand\blankfootnote[1]{%
      \begingroup
      \renewcommand\thefootnote{}\footnote{#1}%
      \addtocounter{footnote}{-1}%
      \endgroup
    }
    \renewcommand*\footnoterule{} % remove footnote ruler
    \setbeamerfont{footnote}{size=\scriptsize}

    % we dont use enumitem since it breaks beamer
    %\setlist[itemize,1]{itemsep=1em}        % When using enumitem this is needed
    %\setlist[itemize]{label=\scriptsize$\blacksquare$}
    \setbeamertemplate{itemize item}{\scriptsize\raise1.25pt\hbox{\donotcoloroutermaths$\blacksquare$}}
    \setbeamertemplate{itemize subitem}{\tiny\raise1.5pt\hbox{\donotcoloroutermaths$\blacktriangleright$}}
    \setbeamertemplate{itemize subsubitem}{\tiny\raise1.5pt\hbox{\donotcoloroutermaths$\blacktriangleright$}}

    \setbeamertemplate{enumerate item}[square]
    %\setbeamercolor{item projected}{bg=black,fg=white}

    % This code makes miniframe signs (small black circles) be on same row as sections
    \makeatletter
        \patchcmd{\slideentry}{\advance\beamer@tempdim by -.05cm}{\advance\beamer@tempdim by\beamer@vboxoffset\advance\beamer@tempdim by\beamer@boxsize\advance\beamer@tempdim by 0.9\pgflinewidth}{}{}
        \patchcmd{\slideentry}{\kern\beamer@tempdim}{\advance\beamer@tempdim by 2pt\advance\beamer@tempdim by\wd\beamer@sectionbox\kern\beamer@tempdim}{}{}
    \makeatother

    % %% TOC
    \setbeamerfont{tocfont}{series=\bfseries,size=\Large}

    % Larger buttons
    \setbeamertemplate{button}{\tikz
      \node[
      inner xsep=5pt,
      draw=structure!95,
      fill=white,
      yshift=7pt,
      xshift=0pt,
      rounded corners=3pt]  {\normalsize\insertbuttontext};}

    % %% FOOTER
    % % \useoutertheme{infolines}
    % \beamertemplatenavigationsymbolsempty   % No navigation
    % % \setfootline{
    % %     \insertshortinstitute, \insertshortdate
    % %     \hfill slide \insertframenumber/\inserttotalframenumber
    % % }
    %     \setbeamertemplate{footline}
    %     {
    %       \leavevmode%
    %       \hbox{%
    %       \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,center]{author in head/foot}%
    %         \usebeamerfont{author in head/foot}\insertsection
    %       \end{beamercolorbox}%
    %       \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,center]{title in head/foot}%
    %         \usebeamerfont{title in head/foot}\insertsubsection
    %       \end{beamercolorbox}%
    %       \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,right]{date in head/foot}%
    %         \usebeamerfont{date in head/foot}\insertshortdate{}\hspace*{2em}
    %         \insertframenumber{} / \inserttotalframenumber\hspace*{2ex}
    %       \end{beamercolorbox}}%
    %       \vskip0pt%
    %     }
    %     \makeatother

    % Footnote on right side
    \setbeamertemplate{footnote}{%
        \parindent 0em\noindent%
        \raggedleft%\raggedright
        \usebeamercolor{footnote}\hbox to 0.8em{\hfil\insertfootnotemark}\insertfootnotetext\par%
    }

\fi

%% ##################### SYNTAX HIGHLIGHTING ###################################

\if@highlighting
    % Syntax highlighting using listings
    \definecolor{mygreen}{RGB}{28,172,0}
    \definecolor{mymagenta}{RGB}{170,55,241}

    \lstdefinelanguage{Stata}{%
        morekeywords = {},
        sensitive = false,
        morecomment = [l]{///},
        morecomment = [l]{*},
        morecomment = [s]{/*}{*/},
        morestring = [b]",
    }
    \lstset{language = Stata,
        keywords = {break,case,catch,continue,else,elseif,end,for,function,
        global,if,otherwise,persistent,return,switch,try,while},
        basicstyle = \footnotesize,
        keywordstyle = \color{blue},
        identifierstyle = \color{black},
        stringstyle = \color{mymagenta},
        commentstyle = \color{mygreen},
        showspaces = false,           % Show spaces
        showstringspaces = false,     % Show spaces in strings
        showtabs = false,             % Show tabs
        tabsize = 2,                % Size of tabs
        captionpos = b,             % Caption position
        numbers = left,             % Line numbers position
        numberstyle = {\footnotesize \color{gray}},
        stepnumber = 1,
        numbersep = 8pt,
        breaklines = true,            % Line breaks
        breakatwhitespace=false     % Break only on white space
    }
    \lstloadlanguages{R}
    \lstdefinelanguage{myR}[]{R}{%
        morekeywords={acf,ar,arima,arima.sim,colMeans,colSums,is.na,is.null, mapply,ms,na.rm,nlmin,replicate,row.names,rowMeans,rowSums,seasonal, sys.time,system.time,ts.plot,which.max,which.min},
        deletekeywords={Call},
        alsoletter={.\%},
        alsoother={:_\$},
        basicstyle = \small\ttfamily,
        keywordstyle = \color{blue},
        identifierstyle = \color{black},
        stringstyle = \color{mymagenta},
        commentstyle = \color{black}\textsl,
        extendedchars=true,
        showspaces = false,             % Show spaces
        showstringspaces = false,       % Show spaces in strings
        showtabs = false,               % Show tabs
        tabsize = 2,                    % Size of tabs
        captionpos = b,                 % Caption position
        breaklines = true,              % Line breaks
        breakatwhitespace=false,        % Break only on white space
        numbers = none,                 % Line numbers position
        numberstyle = {\tiny \color{gray}},
        stepnumber = 1,
        numbersep = 5pt,
        index=[1][keywords]
    }
\fi

%% ##################### ABBREVIATIONS/COMMANDS ################################

\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}
\newcommand{\ubar}[1]{\underaccent{\bar}{#1}}
\newcommand{\Var}[1]{\mathbb{V}\text{ar}\kern-.2em\left[{#1}\right]}
\newcommand{\Cov}[1]{\mathbb{C}\text{ov}\kern-.2em\left[{#1}\right]}
\newcommand{\E}[1]{\mathbb{E}\kern-.2em\left[{#1}\right]}
\newcommand{\Es}[2]{\mathbb{E}_{{#1}}\kern-.2em\left[{#2}\right]} % Exp operator w. subscript
\newcommand{\CVar}[2]{\mathbb{V}\text{ar}\kern-.2em\left[{#1}\middle\vert{#2}\right]}
\newcommand{\CCov}[2]{\mathbb{C}\text{ov}\kern-.2em\left[{#1}\middle\vert{#2}\right]}
\newcommand{\CE}[2]{\mathbb{E}\kern-.2em\left[{#1}\middle\vert{#2}\right]} % conditional expectations
\newcommand{\plim}{\mathrm{plim}}
\newcommand\independent{\protect\mathpalette{\protect\independenT}{\perp}}
\def\independenT#1#2{\mathrel{\rlap{$#1#2$}\mkern2mu{#1#2}}}

% Add closing mark to square root signs
% use \oldsqrt for old behavior
\LetLtxMacro{\oldsqrt}{\sqrt}
\renewcommand{\sqrt}[1][\ ]{%
    \def\DHLindex{#1}\mathpalette\DHLhksqrt}
\def\DHLhksqrt#1#2{%
    \setbox0=\hbox{$#1\oldsqrt[\DHLindex]{#2\,}$}\dimen0=\ht0
    \advance\dimen0-0.2\ht0
    \setbox2=\hbox{\vrule height\ht0 depth -\dimen0}%
    {\box0\lower0.71pt\box2}}

%%%
% Add special \widebar command from
% http://tex.stackexchange.com/questions/16337/can-i-get-a-widebar-without-using-the-mathabx-package
\makeatletter
\let\save@mathaccent\mathaccent
\newcommand*\if@single[3]{%
  \setbox0\hbox{${\mathaccent"0362{#1}}^H$}%
  \setbox2\hbox{${\mathaccent"0362{\kern0pt#1}}^H$}%
  \ifdim\ht0=\ht2 #3\else #2\fi
  }
%The bar will be moved to the right by a half of \macc@kerna, which is computed by amsmath:
\newcommand*\rel@kern[1]{\kern#1\dimexpr\macc@kerna}
%If there's a superscript following the bar, then no negative kern may follow the bar;
%an additional {} makes sure that the superscript is high enough in this case:
\newcommand*\widebar[1]{\@ifnextchar^{{\wide@bar{#1}{0}}}{\wide@bar{#1}{1}}}
%Use a separate algorithm for single symbols:
\newcommand*\wide@bar[2]{\if@single{#1}{\wide@bar@{#1}{#2}{1}}{\wide@bar@{#1}{#2}{2}}}
\newcommand*\wide@bar@[3]{%
  \begingroup
  \def\mathaccent##1##2{%
%Enable nesting of accents:
    \let\mathaccent\save@mathaccent
%If there's more than a single symbol, use the first character instead (see below):
    \if#32 \let\macc@nucleus\first@char \fi
%Determine the italic correction:
    \setbox\z@\hbox{$\macc@style{\macc@nucleus}_{}$}%
    \setbox\tw@\hbox{$\macc@style{\macc@nucleus}{}_{}$}%
    \dimen@\wd\tw@
    \advance\dimen@-\wd\z@
%Now \dimen@ is the italic correction of the symbol.
    \divide\dimen@ 3
    \@tempdima\wd\tw@
    \advance\@tempdima-\scriptspace
%Now \@tempdima is the width of the symbol.
    \divide\@tempdima 10
    \advance\dimen@-\@tempdima
%Now \dimen@ = (italic correction / 3) - (Breite / 10)
    \ifdim\dimen@>\z@ \dimen@0pt\fi
%The bar will be shortened in the case \dimen@<0 !
    \rel@kern{0.6}\kern-\dimen@
    \if#31
      \overline{\rel@kern{-0.6}\kern\dimen@\macc@nucleus\rel@kern{0.4}\kern\dimen@}%
      \advance\dimen@0.4\dimexpr\macc@kerna
%Place the combined final kern (-\dimen@) if it is >0 or if a superscript follows:
      \let\final@kern#2%
      \ifdim\dimen@<\z@ \let\final@kern1\fi
      \if\final@kern1 \kern-\dimen@\fi
    \else
      \overline{\rel@kern{-0.6}\kern\dimen@#1}%
    \fi
  }%
  \macc@depth\@ne
  \let\math@bgroup\@empty \let\math@egroup\macc@set@skewchar
  \mathsurround\z@ \frozen@everymath{\mathgroup\macc@group\relax}%
  \macc@set@skewchar\relax
  \let\mathaccentV\macc@nested@a
%The following initialises \macc@kerna and calls \mathaccent:
  \if#31
    \macc@nested@a\relax111{#1}%
  \else
%If the argument consists of more than one symbol, and if the first token is
%a letter, use that letter for the computations:
    \def\gobble@till@marker##1\endmarker{}%
    \futurelet\first@char\gobble@till@marker#1\endmarker
    \ifcat\noexpand\first@char A\else
      \def\first@char{}%
    \fi
    \macc@nested@a\relax111{\first@char}%
  \fi
  \endgroup
}
\makeatother
%%%

%% ##################### END #################################################

\endinput
